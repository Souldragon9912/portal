<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>My Speed Dial</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <style>
        :root {
            --glass-bg: rgba(255, 255, 255, 0.15);
            --glass-border: rgba(255, 255, 255, 0.2);
            --text-color: white;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            margin: 0;
            padding: 20px;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            min-height: 100vh;
            background-color: #222;
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            color: var(--text-color);
            transition: background-image 0.3s ease;
            display: flex;
            flex-direction: column;
            align-items: center; /* Center everything vertically */
        }

        /* --- CLOCK WIDGET (New) --- */
        .clock-container {
            text-align: center;
            margin-top: 40px;
            margin-bottom: 20px;
            text-shadow: 0 2px 10px rgba(0,0,0,0.5);
        }
        .clock-time {
            font-size: 4rem;
            font-weight: 200;
            letter-spacing: -2px;
            line-height: 1;
        }
        .clock-date {
            font-size: 1.2rem;
            opacity: 0.8;
            margin-top: 5px;
            font-weight: 400;
        }

        /* --- Animated Google Search Bar --- */
        .search-container {
            width: 100%;
            max-width: 600px;
            margin: 20px auto;
            position: relative;
            border-radius: 30px;
            padding: 3px;
            overflow: hidden;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
            transform: translateZ(0); 
        }

        .search-container::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: conic-gradient(
                #4285F4, #DB4437, #F4B400, #0F9D58, #4285F4
            );
            animation: rotate 4s linear infinite;
            z-index: 0;
        }

        @keyframes rotate { 100% { transform: rotate(360deg); } }

        .search-wrapper {
            position: relative;
            z-index: 1;
            background: rgba(30, 30, 30, 0.9);
            border-radius: 28px;
            display: flex;
            align-items: center;
            padding: 5px 15px;
            backdrop-filter: blur(10px);
        }

        /* Search Engine Switcher Icon */
        .search-icon {
            width: 24px;
            height: 24px;
            margin-right: 10px;
            cursor: pointer;
            border-radius: 50%;
            transition: transform 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 14px;
            background: #444;
            color: white;
            user-select: none;
        }
        .search-icon:hover { transform: scale(1.1); background: #555; }

        .search-bar {
            width: 100%;
            padding: 10px 5px;
            border: none; 
            background: transparent;
            color: white;
            font-size: 1.1rem;
            outline: none;
        }

        /* --- Weather Widget --- */
        .weather-widget {
            max-width: 300px;
            margin: 0 auto 40px;
            text-align: center;
            padding: 8px 16px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 20px;
            backdrop-filter: blur(5px);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            font-size: 0.95rem;
            color: rgba(255, 255, 255, 0.9);
            border: 1px solid rgba(255,255,255,0.1);
            cursor: pointer;
            transition: transform 0.2s, background 0.2s;
        }
        
        .weather-widget:hover {
            background: rgba(0, 0, 0, 0.5);
            transform: scale(1.02);
        }

        /* --- Grid Layout --- */
        .grid {
            width: 100%;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(110px, 1fr));
            gap: 20px;
            max-width: 1000px;
            margin: 0 auto;
            padding-bottom: 80px;
        }

        /* --- Cards --- */
        .card {
            background: var(--glass-bg);
            backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border);
            border-radius: 16px;
            aspect-ratio: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: transform 0.2s, background 0.2s;
            text-decoration: none;
            color: white;
            position: relative;
            padding: 10px;
            text-align: center;
            user-select: none;
            -webkit-user-select: none;
        }

        .card:hover {
            transform: translateY(-5px);
            background: rgba(255, 255, 255, 0.25);
        }

        .card-icon {
            width: 48px;
            height: 48px;
            border-radius: 8px;
            margin-bottom: 10px;
            object-fit: contain;
            pointer-events: none;
        }

        .card-title {
            font-size: 0.9rem;
            font-weight: 500;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            width: 100%;
            text-shadow: 0 1px 3px rgba(0,0,0,0.8);
            pointer-events: none;
        }

        .delete-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(255, 0, 0, 0.7);
            border: none;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 12px;
            display: none;
            cursor: pointer;
            z-index: 10;
        }

        .edit-mode .delete-btn { display: block; }
        .edit-mode .card { animation: shake 0.3s infinite alternate; cursor: grab; }
        .edit-mode .card:active { cursor: grabbing; }

        @keyframes shake { from { transform: rotate(-1deg); } to { transform: rotate(1deg); } }
        .sortable-ghost { opacity: 0.4; background: rgba(255, 255, 255, 0.1); }

        /* --- FABs --- */
        .fab-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            display: flex;
            gap: 10px;
            z-index: 100;
        }

        .fab {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: none;
            background: #007AFF;
            color: white;
            font-size: 24px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .fab.settings { background: #333; }
        .fab.edit { background: #ff9500; }
        .fab.notes { background: #ffd60a; color: #333; }
        .fab.edit.active { background: white; color: #ff9500; border: 2px solid #ff9500; }

        /* --- Modals --- */
        .modal {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.8);
            z-index: 200;
            align-items: center;
            justify-content: center;
        }

        .modal.active { display: flex; }

        .modal-content {
            background: #222;
            padding: 25px;
            border-radius: 16px;
            width: 90%;
            max-width: 400px;
            color: white;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-content h2 { margin-top: 0; }

        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-size: 0.9rem; color: #aaa; }
        .form-group input, .form-group select {
            width: 100%;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid #444;
            background: #333;
            color: white;
            font-size: 1rem;
        }

        .notes-area {
            width: 100%;
            height: 300px;
            background: #333;
            border: 1px solid #444;
            color: white;
            padding: 15px;
            border-radius: 8px;
            font-family: monospace;
            font-size: 1rem;
            resize: none;
            outline: none;
        }
        .notes-area:focus { border-color: #ffd60a; }

        .icon-search-results {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 10px;
            margin-top: 10px;
            max-height: 150px;
            overflow-y: auto;
            background: rgba(0,0,0,0.2);
            padding: 10px;
            border-radius: 8px;
        }
        .icon-result {
            width: 100%;
            aspect-ratio: 1;
            background: #444;
            border: 1px solid #555;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .icon-result:hover { background: #007AFF; border-color: #007AFF; }
        .icon-result img { width: 24px; height: 24px; }

        .btn-group { display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px; }
        .btn {
            padding: 10px 20px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-weight: bold;
            text-align: center;
        }
        .btn-primary { background: #007AFF; color: white; }
        .btn-secondary { background: #444; color: white; }

        .breadcrumbs {
            max-width: 1000px;
            width: 100%;
            margin: 0 auto 20px;
            padding: 0 10px;
            font-size: 1.2rem;
            cursor: pointer;
            text-shadow: 0 1px 3px rgba(0,0,0,0.8);
        }
        .breadcrumb-item:hover { text-decoration: underline; }

    </style>
</head>
<body>

    <div class="clock-container">
        <div class="clock-time" id="clockTime">00:00</div>
        <div class="clock-date" id="clockDate">Loading Date...</div>
    </div>

    <div class="search-container">
        <form id="searchForm" action="https://www.google.com/search" method="GET" target="_blank" onsubmit="setTimeout(() => this.reset(), 500)">
            <div class="search-wrapper">
                <div class="search-icon" id="searchIcon" onclick="app.toggleSearchEngine()" title="Switch Search Engine">G</div>
                <input type="text" name="q" id="searchInput" class="search-bar" placeholder="Search Google..." autocomplete="off">
            </div>
        </form>
    </div>

    <div id="weather" class="weather-widget" onclick="app.fetchWeather(true)">
        <span>Loading Weather...</span>
    </div>

    <div class="breadcrumbs" id="breadcrumbs" style="display: none;">
        <span class="breadcrumb-item" onclick="app.goHome()">üè† Home</span> <span id="folder-name"></span>
    </div>

    <div class="grid" id="grid"></div>

    <div class="fab-container">
        <button class="fab notes" onclick="app.openNotes()" title="Notes">üìù</button>
        <button id="editBtn" class="fab edit" onclick="app.toggleEditMode()" title="Edit/Delete">‚úé</button>
        <button class="fab settings" onclick="app.openSettings()" title="Settings">‚öôÔ∏è</button>
        <button class="fab" onclick="app.openAddModal()" title="Add New">+</button>
    </div>

    <div class="modal" id="addModal">
        <div class="modal-content">
            <h2 id="modalTitle">Add Item</h2>
            <div class="form-group">
                <label>Type</label>
                <select id="itemType" onchange="app.toggleTypeInputs()">
                    <option value="link">Link</option>
                    <option value="folder">Folder</option>
                </select>
            </div>
            <div class="form-group">
                <label>Name</label>
                <input type="text" id="itemName" placeholder="e.g., YouTube">
            </div>
            <div class="form-group" id="urlInputGroup">
                <label>URL</label>
                <input type="url" id="itemUrl" placeholder="https://youtube.com">
            </div>
            <div class="form-group">
                <label>Icon</label>
                <div style="display: flex; gap: 5px; margin-bottom: 5px;">
                    <input type="text" id="iconSearchInput" placeholder="Search icon (e.g. twitter)" style="margin-bottom:0">
                    <button class="btn btn-secondary" onclick="app.searchIcons()">üîç</button>
                </div>
                <div id="iconResults" class="icon-search-results" style="display:none;"></div>
                <div style="text-align: center; margin: 10px 0; font-size: 0.8rem; color: #888;">- OR -</div>
                <input type="file" id="itemIconInput" accept="image/*">
                <p style="font-size: 0.8rem; color: #888; margin-top: 5px;">Upload your own image</p>
            </div>
            <div class="btn-group">
                <button class="btn btn-secondary" onclick="app.closeModals()">Cancel</button>
                <button class="btn btn-primary" onclick="app.saveItem()">Save</button>
            </div>
        </div>
    </div>

    <div class="modal" id="notesModal">
        <div class="modal-content">
            <h2>Notepad</h2>
            <p style="font-size: 0.8rem; color: #888; margin-bottom: 10px;">Auto-saves as you type.</p>
            <textarea id="notesInput" class="notes-area" placeholder="Type your notes here..." oninput="app.saveNotes()"></textarea>
            <div class="btn-group">
                <button class="btn btn-secondary" onclick="app.closeModals()">Close</button>
            </div>
        </div>
    </div>

    <div class="modal" id="settingsModal">
        <div class="modal-content">
            <h2>Settings</h2>
            <div class="form-group">
                <label>Background Image</label>
                <input type="file" id="bgInput" accept="image/*" onchange="app.handleBgUpload(this)">
                <p style="font-size: 0.8rem; color: #888; margin-top: 5px;">Images are saved to your browser storage.</p>
            </div>
            <div class="form-group">
                <label>Weather Location (City)</label>
                <input type="text" id="cityInput" placeholder="Leave empty to use GPS">
                <button class="btn btn-primary" style="width: 100%; margin-top: 10px;" onclick="app.saveCity()">Update Weather</button>
            </div>
            <hr style="border: 0; border-top: 1px solid #444; margin: 20px 0;">
            <div class="form-group">
                <label>Backup & Restore</label>
                <div class="btn-group" style="justify-content: space-between; margin-top: 5px;">
                    <button class="btn btn-secondary" style="width: 48%" onclick="app.exportData()">‚¨áÔ∏è Export</button>
                    <button class="btn btn-secondary" style="width: 48%" onclick="document.getElementById('importFile').click()">‚¨ÜÔ∏è Import</button>
                    <input type="file" id="importFile" style="display: none" accept=".json" onchange="app.importData(this)">
                </div>
            </div>
            <hr style="border: 0; border-top: 1px solid #444; margin: 20px 0;">
            <div class="form-group">
                <label>Danger Zone</label>
                <button class="btn btn-secondary" style="background: #a33; width: 100%" onclick="app.resetAll()">Reset All Data</button>
            </div>
            <div class="btn-group">
                <button class="btn btn-secondary" onclick="app.closeModals()">Close</button>
            </div>
        </div>
    </div>

<script>
const app = (() => {
    let data = JSON.parse(localStorage.getItem('speedDialData')) || {
        root: [], folders: {}, bg: null, city: '', notes: ''
    };
    let currentFolderId = null; 
    let isEditMode = false;
    let selectedIconData = null;
    let sortableInstance = null;
    
    // Search Engine State
    const engines = [
        { name: 'Google', url: 'https://www.google.com/search', icon: 'G', placeholder: 'Search Google...' },
        { name: 'DuckDuckGo', url: 'https://duckduckgo.com/', icon: 'D', placeholder: 'Search DuckDuckGo...' },
        { name: 'YouTube', url: 'https://www.youtube.com/results', icon: 'Y', placeholder: 'Search YouTube...' },
        { name: 'Reddit', url: 'https://www.reddit.com/search', icon: 'R', placeholder: 'Search Reddit...' }
    ];
    let currentEngineIndex = 0;

    const init = () => {
        applyBg();
        render();
        fetchWeather();
        startClock(); // Start Clock
        document.getElementById('cityInput').value = data.city || '';
        document.getElementById('notesInput').value = data.notes || '';
        
        const grid = document.getElementById('grid');
        sortableInstance = Sortable.create(grid, {
            animation: 150, disabled: true, ghostClass: 'sortable-ghost',
            onEnd: function (evt) {
                const list = currentFolderId ? data.folders[currentFolderId] : data.root;
                const item = list.splice(evt.oldIndex, 1)[0];
                list.splice(evt.newIndex, 0, item);
                save();
            }
        });
    };

    const save = () => { localStorage.setItem('speedDialData', JSON.stringify(data)); render(); };

    // --- CLOCK Logic ---
    const startClock = () => {
        const update = () => {
            const now = new Date();
            let hours = now.getHours();
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const ampm = hours >= 12 ? 'PM' : 'AM';
            hours = hours % 12;
            hours = hours ? hours : 12;
            
            document.getElementById('clockTime').innerText = `${hours}:${minutes} ${ampm}`;
            
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            document.getElementById('clockDate').innerText = now.toLocaleDateString(undefined, options);
        };
        update();
        setInterval(update, 1000);
    };

    // --- SEARCH Logic ---
    const toggleSearchEngine = () => {
        currentEngineIndex = (currentEngineIndex + 1) % engines.length;
        const engine = engines[currentEngineIndex];
        
        // Update Form
        const form = document.getElementById('searchForm');
        form.action = engine.url;
        
        // Update Icon
        const icon = document.getElementById('searchIcon');
        icon.innerText = engine.icon;
        
        // Update Input
        const input = document.getElementById('searchInput');
        input.placeholder = engine.placeholder;
        
        // Special handling for YouTube/Reddit param names if needed (Google/DDG/Reddit use 'q', YT uses 'search_query')
        if (engine.name === 'YouTube') {
            input.name = 'search_query';
        } else {
            input.name = 'q';
        }
    };

    const readFileAsBase64 = (file) => new Promise((res, rej) => {
        const r = new FileReader(); r.onload = () => res(r.result); r.onerror = rej; r.readAsDataURL(file);
    });

    // --- Standard Functions (Same as before) ---
    const openNotes = () => document.getElementById('notesModal').classList.add('active');
    const saveNotes = () => { data.notes = document.getElementById('notesInput').value; localStorage.setItem('speedDialData', JSON.stringify(data)); };
    
    const searchIcons = async () => {
        const query = document.getElementById('iconSearchInput').value.trim();
        if(!query) return;
        const c = document.getElementById('iconResults'); c.style.display = 'grid'; c.innerHTML = '...';
        try {
            const req = await fetch(`https://api.iconify.design/search?query=${encodeURIComponent(query)}&limit=15`);
            const res = await req.json();
            c.innerHTML = '';
            res.icons.forEach(n => {
                const b = document.createElement('div'); b.className = 'icon-result';
                const u = `https://api.iconify.design/${n}.svg`;
                b.innerHTML = `<img src="${u}">`;
                b.onclick = async () => {
                    document.querySelectorAll('.icon-result').forEach(x => x.style.borderColor = '#555');
                    b.style.borderColor = '#007AFF'; b.style.background = '#007AFF';
                    const t = await (await fetch(u)).text();
                    selectedIconData = "data:image/svg+xml;base64," + btoa(t);
                };
                c.appendChild(b);
            });
        } catch(e) { c.innerHTML = 'Error'; }
    };

    const exportData = () => {
        const s = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(data));
        const a = document.createElement('a'); a.href = s; a.download = "backup.json"; document.body.appendChild(a); a.click(); a.remove();
    };

    const importData = (input) => {
        const f = input.files[0]; if (!f) return;
        const r = new FileReader(); r.onload = (e) => {
            try {
                const d = JSON.parse(e.target.result); if (!d.root) throw new Error();
                if(confirm("Overwrite?")) { data = d; localStorage.setItem('speedDialData', JSON.stringify(data)); location.reload(); }
            } catch (err) { alert("Error"); }
        }; r.readAsText(f);
    };

    const fetchWeather = async () => {
        const el = document.getElementById('weather');
        try {
            let lat, lon, name;
            if (data.city) {
                const g = await (await fetch(`https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(data.city)}&count=1&language=en&format=json`)).json();
                if (!g.results) { el.innerHTML = "üö´ City not found"; return; }
                lat = g.results[0].latitude; lon = g.results[0].longitude; name = g.results[0].name;
            } else {
                if (!navigator.geolocation) { el.innerHTML = "üìç Location unavailable"; return; }
                const pos = await new Promise((res, rej) => navigator.geolocation.getCurrentPosition(res, rej));
                lat = pos.coords.latitude; lon = pos.coords.longitude; name = "My Location";
            }
            const w = await (await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true&temperature_unit=fahrenheit&weathercode=true`)).json();
            el.innerHTML = `${getWeatherIcon(w.current_weather.weathercode)} ${Math.round(w.current_weather.temperature)}¬∞F ‚Ä¢ ${name}`;
        } catch (err) { el.innerHTML = data.city ? "‚ö†Ô∏è Weather Error" : "üìç Enable GPS"; }
    };

    const getWeatherIcon = (c) => (c===0?'‚òÄÔ∏è':c<=3?'‚òÅÔ∏è':c<=48?'üå´Ô∏è':c<=67?'üåßÔ∏è':c<=77?'‚ùÑÔ∏è':c<=82?'üåßÔ∏è':'‚õàÔ∏è');
    const saveCity = () => { data.city = document.getElementById('cityInput').value.trim(); save(); fetchWeather(); closeModals(); };

    const render = () => {
        const grid = document.getElementById('grid'); grid.innerHTML = '';
        const items = currentFolderId ? (data.folders[currentFolderId] || []) : data.root;
        const bc = document.getElementById('breadcrumbs');
        const fn = document.getElementById('folder-name');

        if (currentFolderId) {
            bc.style.display = 'block';
            const f = data.root.find(i => i.id === currentFolderId);
            fn.innerText = f ? ` > üìÅ ${f.name}` : ' > Folder';
        } else { bc.style.display = 'none'; }

        items.forEach((item, index) => {
            const card = document.createElement('div'); card.className = 'card'; card.setAttribute('data-id', item.id);
            let iconSrc = item.icon || '';
            if (!iconSrc) {
                if (item.type === 'folder') iconSrc = "data:image/svg+xml;charset=utf8,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23007AFF'%3E%3Cpath d='M10 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2h-8l-2-2z'/%3E%3C/svg%3E";
                else {
                    try { const d = new URL(item.url).hostname; iconSrc = `https://www.google.com/s2/favicons?domain=${d}&sz=64`; } 
                    catch (e) { iconSrc = "data:image/svg+xml;charset=utf8,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23ccc'%3E%3Ccircle cx='12' cy='12' r='10'/%3E%3C/svg%3E"; }
                }
            }
            card.innerHTML = `<button class="delete-btn" onclick="event.stopPropagation(); app.deleteItem(${index})">√ó</button><img src="${iconSrc}" class="card-icon" onerror="this.style.display='none'"><div class="card-title">${item.name}</div>`;
            card.onclick = (e) => {
                if (isEditMode) e.preventDefault();
                else if (item.type === 'folder') openFolder(item.id);
                else window.open(item.url, '_blank');
            };
            grid.appendChild(card);
        });
        
        grid.className = isEditMode ? 'grid edit-mode' : 'grid';
        document.getElementById('editBtn').classList.toggle('active', isEditMode);
        if(sortableInstance) sortableInstance.option("disabled", !isEditMode);
    };

    const openFolder = (id) => { currentFolderId = id; render(); };
    const goHome = () => { currentFolderId = null; render(); };
    const deleteItem = (index) => {
        if (!confirm('Delete?')) return;
        const list = currentFolderId ? data.folders[currentFolderId] : data.root;
        const item = list[index];
        if (item.type === 'folder' && data.folders[item.id]) delete data.folders[item.id];
        list.splice(index, 1); save();
    };

    const saveItem = async () => {
        const type = document.getElementById('itemType').value;
        const name = document.getElementById('itemName').value;
        const url = document.getElementById('itemUrl').value;
        const iconInput = document.getElementById('itemIconInput');
        if (!name) return alert('Name required');
        if (type === 'link' && !url) return alert('URL required');
        
        let finalIcon = null;
        if (iconInput.files && iconInput.files[0]) {
            if (iconInput.files[0].size > 2000000) return alert('Icon too large');
            finalIcon = await readFileAsBase64(iconInput.files[0]);
        } else if (selectedIconData) finalIcon = selectedIconData;

        const newItem = { id: Date.now().toString(), type, name, url: type === 'link' ? (url.startsWith('http') ? url : `https://${url}`) : null, icon: finalIcon };
        if (type === 'folder') data.folders[newItem.id] = [];
        (currentFolderId ? data.folders[currentFolderId] : data.root).push(newItem);
        save(); closeModals();
        document.getElementById('itemName').value = ''; document.getElementById('itemUrl').value = ''; 
        document.getElementById('itemIconInput').value = ''; document.getElementById('iconSearchInput').value = ''; 
        document.getElementById('iconResults').style.display = 'none'; selectedIconData = null;
    };

    const handleBgUpload = async (input) => {
        if (input.files && input.files[0]) {
            if (input.files[0].size > 12000000) return alert('Image too large');
            try { data.bg = await readFileAsBase64(input.files[0]); save(); applyBg(); } catch (e) { alert("Error"); }
        }
    };

    const applyBg = () => { if (data.bg) document.body.style.backgroundImage = `url('${data.bg}')`; };
    const resetAll = () => { if(confirm("Reset all?")) { localStorage.removeItem('speedDialData'); location.reload(); } };
    const toggleEditMode = () => { isEditMode = !isEditMode; render(); };
    const openAddModal = () => document.getElementById('addModal').classList.add('active');
    const openSettings = () => document.getElementById('settingsModal').classList.add('active');
    const closeModals = () => document.querySelectorAll('.modal').forEach(m => m.classList.remove('active'));
    const toggleTypeInputs = () => { document.getElementById('urlInputGroup').style.display = document.getElementById('itemType').value === 'folder' ? 'none' : 'block'; };

    return { init, saveItem, deleteItem, openFolder, goHome, toggleEditMode, openAddModal, openSettings, closeModals, toggleTypeInputs, handleBgUpload, resetAll, saveCity, fetchWeather, exportData, importData, searchIcons, openNotes, saveNotes, toggleSearchEngine };
})();

app.init();
</script>
</body>
</html>
