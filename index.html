<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>My Speed Dial</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <style>
        :root {
            --glass-bg: rgba(255, 255, 255, 0.15);
            --glass-border: rgba(255, 255, 255, 0.2);
            --text-color: white;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            margin: 0;
            padding: 20px;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            min-height: 100vh;
            background-color: #222;
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            color: var(--text-color);
            transition: background-image 0.3s ease;
        }

        /* --- Animated Google Search Bar --- */
        .search-container {
            max-width: 600px;
            margin: 40px auto 20px;
            position: relative;
            border-radius: 30px;
            padding: 3px;
            overflow: hidden;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
            transform: translateZ(0); 
        }

        .search-container::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: conic-gradient(
                #4285F4, #DB4437, #F4B400, #0F9D58, #4285F4
            );
            animation: rotate 4s linear infinite;
            z-index: 0;
        }

        @keyframes rotate { 100% { transform: rotate(360deg); } }

        .search-bar {
            position: relative;
            z-index: 1;
            width: 100%;
            padding: 15px 25px;
            border-radius: 28px;
            border: none; 
            background: rgba(30, 30, 30, 0.9);
            color: white;
            font-size: 1.1rem;
            backdrop-filter: blur(10px);
            outline: none;
            text-align: center;
        }

        /* --- Weather Widget --- */
        .weather-widget {
            max-width: 300px;
            margin: 0 auto 40px;
            text-align: center;
            padding: 8px 16px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 20px;
            backdrop-filter: blur(5px);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            font-size: 0.95rem;
            color: rgba(255, 255, 255, 0.9);
            border: 1px solid rgba(255,255,255,0.1);
            cursor: pointer;
            transition: transform 0.2s, background 0.2s;
        }
        
        .weather-widget:hover {
            background: rgba(0, 0, 0, 0.5);
            transform: scale(1.02);
        }

        /* --- Grid Layout --- */
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(110px, 1fr));
            gap: 20px;
            max-width: 1000px;
            margin: 0 auto;
            padding-bottom: 80px;
        }

        /* --- Cards --- */
        .card {
            background: var(--glass-bg);
            backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border);
            border-radius: 16px;
            aspect-ratio: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: transform 0.2s, background 0.2s;
            text-decoration: none;
            color: white;
            position: relative;
            padding: 10px;
            text-align: center;
            user-select: none; /* Prevent text selection while dragging */
            -webkit-user-select: none;
        }

        .card:hover {
            transform: translateY(-5px);
            background: rgba(255, 255, 255, 0.25);
        }

        .card-icon {
            width: 48px;
            height: 48px;
            border-radius: 8px;
            margin-bottom: 10px;
            object-fit: contain;
            pointer-events: none; /* Helps with drag handling */
        }

        .card-title {
            font-size: 0.9rem;
            font-weight: 500;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            width: 100%;
            text-shadow: 0 1px 3px rgba(0,0,0,0.8);
            pointer-events: none;
        }

        /* Delete Button */
        .delete-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(255, 0, 0, 0.7);
            border: none;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 12px;
            display: none;
            cursor: pointer;
            z-index: 10;
        }

        .edit-mode .delete-btn { display: block; }
        
        /* Wiggle Animation for Edit Mode */
        .edit-mode .card { 
            animation: shake 0.3s infinite alternate; 
            cursor: grab;
        }
        .edit-mode .card:active {
            cursor: grabbing;
        }

        @keyframes shake { from { transform: rotate(-1deg); } to { transform: rotate(1deg); } }

        /* Drag Ghost (The item being dragged) */
        .sortable-ghost {
            opacity: 0.4;
            background: rgba(255, 255, 255, 0.1);
        }

        /* --- FABs --- */
        .fab-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            display: flex;
            gap: 10px;
            z-index: 100;
        }

        .fab {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: none;
            background: #007AFF;
            color: white;
            font-size: 24px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .fab.settings { background: #333; }
        .fab.edit { background: #ff9500; }
        
        /* Active state for Edit button */
        .fab.edit.active { 
            background: white; 
            color: #ff9500; 
            border: 2px solid #ff9500;
        }

        /* --- Modals --- */
        .modal {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.8);
            z-index: 200;
            align-items: center;
            justify-content: center;
        }

        .modal.active { display: flex; }

        .modal-content {
            background: #222;
            padding: 25px;
            border-radius: 16px;
            width: 90%;
            max-width: 400px;
            color: white;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-content h2 { margin-top: 0; }

        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-size: 0.9rem; color: #aaa; }
        .form-group input, .form-group select {
            width: 100%;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid #444;
            background: #333;
            color: white;
            font-size: 1rem;
        }

        /* --- Icon Search Styles --- */
        .icon-search-results {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 10px;
            margin-top: 10px;
            max-height: 150px;
            overflow-y: auto;
            background: rgba(0,0,0,0.2);
            padding: 10px;
            border-radius: 8px;
        }
        .icon-result {
            width: 100%;
            aspect-ratio: 1;
            background: #444;
            border: 1px solid #555;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .icon-result:hover { background: #007AFF; border-color: #007AFF; }
        .icon-result img { width: 24px; height: 24px; }

        .btn-group { display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px; }
        .btn {
            padding: 10px 20px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-weight: bold;
            text-align: center;
        }
        .btn-primary { background: #007AFF; color: white; }
        .btn-secondary { background: #444; color: white; }

        /* --- Breadcrumbs --- */
        .breadcrumbs {
            max-width: 1000px;
            margin: 0 auto 20px;
            padding: 0 10px;
            font-size: 1.2rem;
            cursor: pointer;
            text-shadow: 0 1px 3px rgba(0,0,0,0.8);
        }
        .breadcrumb-item:hover { text-decoration: underline; }

    </style>
</head>
<body>

    <div class="search-container">
        <form action="https://www.google.com/search" method="GET" target="_blank" onsubmit="setTimeout(() => this.reset(), 500)">
            <input type="text" name="q" class="search-bar" placeholder="Search Google..." autocomplete="off">
        </form>
    </div>

    <div id="weather" class="weather-widget" onclick="app.fetchWeather(true)">
        <span>Loading Weather...</span>
    </div>

    <div class="breadcrumbs" id="breadcrumbs" style="display: none;">
        <span class="breadcrumb-item" onclick="app.goHome()">üè† Home</span> <span id="folder-name"></span>
    </div>

    <div class="grid" id="grid">
        </div>

    <div class="fab-container">
        <button id="editBtn" class="fab edit" onclick="app.toggleEditMode()" title="Edit/Delete">‚úé</button>
        <button class="fab settings" onclick="app.openSettings()" title="Settings">‚öôÔ∏è</button>
        <button class="fab" onclick="app.openAddModal()" title="Add New">+</button>
    </div>

    <div class="modal" id="addModal">
        <div class="modal-content">
            <h2 id="modalTitle">Add Item</h2>
            <div class="form-group">
                <label>Type</label>
                <select id="itemType" onchange="app.toggleTypeInputs()">
                    <option value="link">Link</option>
                    <option value="folder">Folder</option>
                </select>
            </div>
            <div class="form-group">
                <label>Name</label>
                <input type="text" id="itemName" placeholder="e.g., YouTube">
            </div>
            <div class="form-group" id="urlInputGroup">
                <label>URL</label>
                <input type="url" id="itemUrl" placeholder="https://youtube.com">
            </div>
            
            <div class="form-group">
                <label>Icon</label>
                <div style="display: flex; gap: 5px; margin-bottom: 5px;">
                    <input type="text" id="iconSearchInput" placeholder="Search icon (e.g. twitter)" style="margin-bottom:0">
                    <button class="btn btn-secondary" onclick="app.searchIcons()">üîç</button>
                </div>
                <div id="iconResults" class="icon-search-results" style="display:none;"></div>
                <div style="text-align: center; margin: 10px 0; font-size: 0.8rem; color: #888;">- OR -</div>
                <input type="file" id="itemIconInput" accept="image/*">
                <p style="font-size: 0.8rem; color: #888; margin-top: 5px;">Upload your own image</p>
            </div>

            <div class="btn-group">
                <button class="btn btn-secondary" onclick="app.closeModals()">Cancel</button>
                <button class="btn btn-primary" onclick="app.saveItem()">Save</button>
            </div>
        </div>
    </div>

    <div class="modal" id="settingsModal">
        <div class="modal-content">
            <h2>Settings</h2>
            
            <div class="form-group">
                <label>Background Image</label>
                <input type="file" id="bgInput" accept="image/*" onchange="app.handleBgUpload(this)">
                <p style="font-size: 0.8rem; color: #888; margin-top: 5px;">Images are saved to your browser storage.</p>
            </div>

            <div class="form-group">
                <label>Weather Location (City)</label>
                <input type="text" id="cityInput" placeholder="Leave empty to use GPS">
                <button class="btn btn-primary" style="width: 100%; margin-top: 10px;" onclick="app.saveCity()">Update Weather</button>
            </div>

            <hr style="border: 0; border-top: 1px solid #444; margin: 20px 0;">

            <div class="form-group">
                <label>Backup & Restore</label>
                <div class="btn-group" style="justify-content: space-between; margin-top: 5px;">
                    <button class="btn btn-secondary" style="width: 48%" onclick="app.exportData()">‚¨áÔ∏è Export</button>
                    <button class="btn btn-secondary" style="width: 48%" onclick="document.getElementById('importFile').click()">‚¨ÜÔ∏è Import</button>
                    <input type="file" id="importFile" style="display: none" accept=".json" onchange="app.importData(this)">
                </div>
            </div>

            <hr style="border: 0; border-top: 1px solid #444; margin: 20px 0;">

            <div class="form-group">
                <label>Danger Zone</label>
                <button class="btn btn-secondary" style="background: #a33; width: 100%" onclick="app.resetAll()">Reset All Data</button>
            </div>
            
            <div class="btn-group">
                <button class="btn btn-secondary" onclick="app.closeModals()">Close</button>
            </div>
        </div>
    </div>

<script>
const app = (() => {
    // --- State ---
    let data = JSON.parse(localStorage.getItem('speedDialData')) || {
        root: [],
        folders: {},
        bg: null,
        city: '' 
    };
    
    let currentFolderId = null; 
    let isEditMode = false;
    let selectedIconData = null;
    let sortableInstance = null; // Store the sortable instance

    // --- Core Functions ---
    const init = () => {
        applyBg();
        render();
        fetchWeather();
        document.getElementById('cityInput').value = data.city || '';
        
        // Initialize Sortable (Disabled by default)
        const grid = document.getElementById('grid');
        sortableInstance = Sortable.create(grid, {
            animation: 150,
            disabled: true, // Only enabled in edit mode
            ghostClass: 'sortable-ghost',
            onEnd: function (evt) {
                // Reorder Data
                const list = currentFolderId ? data.folders[currentFolderId] : data.root;
                const item = list.splice(evt.oldIndex, 1)[0];
                list.splice(evt.newIndex, 0, item);
                save();
            }
        });
    };

    const save = () => {
        localStorage.setItem('speedDialData', JSON.stringify(data));
        render(); // Re-render to ensure DOM matches state
    };

    const readFileAsBase64 = (file) => {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = () => resolve(reader.result);
            reader.onerror = reject;
            reader.readAsDataURL(file);
        });
    };

    // --- Icon Search (Iconify) ---
    const searchIcons = async () => {
        const query = document.getElementById('iconSearchInput').value.trim();
        if(!query) return;
        const resultsContainer = document.getElementById('iconResults');
        resultsContainer.style.display = 'grid';
        resultsContainer.innerHTML = '<div style="color:#aaa; grid-column:span 5; text-align:center">Searching...</div>';
        try {
            const req = await fetch(`https://api.iconify.design/search?query=${encodeURIComponent(query)}&limit=15`);
            const res = await req.json();
            resultsContainer.innerHTML = '';
            if(!res.icons || res.icons.length === 0) {
                resultsContainer.innerHTML = '<div style="color:#aaa; grid-column:span 5; text-align:center">No icons found</div>';
                return;
            }
            res.icons.forEach(iconName => {
                const btn = document.createElement('div');
                btn.className = 'icon-result';
                const iconUrl = `https://api.iconify.design/${iconName}.svg`;
                btn.innerHTML = `<img src="${iconUrl}">`;
                btn.onclick = async () => {
                    document.querySelectorAll('.icon-result').forEach(b => b.style.borderColor = '#555');
                    btn.style.borderColor = '#007AFF';
                    btn.style.background = '#007AFF';
                    try {
                        const svgReq = await fetch(iconUrl);
                        const svgText = await svgReq.text();
                        selectedIconData = "data:image/svg+xml;base64," + btoa(svgText);
                    } catch(e) { console.error(e); }
                };
                resultsContainer.appendChild(btn);
            });
        } catch(e) { resultsContainer.innerHTML = '<div style="color:#f55; grid-column:span 5; text-align:center">Error</div>'; }
    };

    // --- Data Export/Import ---
    const exportData = () => {
        const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(data));
        const anchor = document.createElement('a');
        anchor.setAttribute("href", dataStr);
        anchor.setAttribute("download", "speed-dial-backup.json");
        document.body.appendChild(anchor); anchor.click(); anchor.remove();
    };

    const importData = (input) => {
        const file = input.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const imported = JSON.parse(e.target.result);
                if (!imported.root) throw new Error("Invalid format");
                if(confirm("Overwrite current links?")) {
                    data = imported;
                    localStorage.setItem('speedDialData', JSON.stringify(data));
                    location.reload();
                }
            } catch (err) { alert("Error: " + err.message); }
        };
        reader.readAsText(file);
    };

    // --- Weather ---
    const fetchWeather = async (forceRefresh = false) => {
        const el = document.getElementById('weather');
        try {
            let lat, lon, name;
            if (data.city) {
                const geo = await fetch(`https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(data.city)}&count=1&language=en&format=json`);
                const geoRes = await geo.json();
                if (!geoRes.results) { el.innerHTML = "üö´ City not found"; return; }
                lat = geoRes.results[0].latitude; lon = geoRes.results[0].longitude; name = geoRes.results[0].name;
            } else {
                if (!navigator.geolocation) { el.innerHTML = "üìç Location unavailable"; return; }
                const pos = await new Promise((res, rej) => navigator.geolocation.getCurrentPosition(res, rej));
                lat = pos.coords.latitude; lon = pos.coords.longitude; name = "My Location";
            }
            const wReq = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true&temperature_unit=fahrenheit&weathercode=true`);
            const wRes = await wReq.json();
            el.innerHTML = `${getWeatherIcon(wRes.current_weather.weathercode)} ${Math.round(wRes.current_weather.temperature)}¬∞F ‚Ä¢ ${name}`;
        } catch (err) { el.innerHTML = data.city ? "‚ö†Ô∏è Weather Error" : "üìç Enable GPS or set City"; }
    };

    const getWeatherIcon = (code) => {
        if (code === 0) return '‚òÄÔ∏è';
        if (code <= 3) return '‚òÅÔ∏è';
        if (code <= 48) return 'üå´Ô∏è';
        if (code <= 67) return 'üåßÔ∏è';
        if (code <= 77) return '‚ùÑÔ∏è';
        if (code <= 82) return 'üåßÔ∏è';
        return '‚õàÔ∏è';
    };

    const saveCity = () => { data.city = document.getElementById('cityInput').value.trim(); save(); fetchWeather(true); closeModals(); };

    // --- Rendering ---
    const render = () => {
        const grid = document.getElementById('grid');
        // NOTE: SortableJS requires we don't nuke innerHTML completely if we want to keep state, 
        // but for this simple app, re-rendering is safer for data consistency.
        grid.innerHTML = '';
        
        const items = currentFolderId ? (data.folders[currentFolderId] || []) : data.root;
        
        // Update Breadcrumbs
        const breadcrumbs = document.getElementById('breadcrumbs');
        const folderName = document.getElementById('folder-name');
        if (currentFolderId) {
            breadcrumbs.style.display = 'block';
            const f = data.root.find(i => i.id === currentFolderId);
            folderName.innerText = f ? ` > üìÅ ${f.name}` : ' > Folder';
        } else {
            breadcrumbs.style.display = 'none';
        }

        items.forEach((item, index) => {
            const card = document.createElement('div');
            card.className = 'card';
            // Set data-id for SortableJS (optional but good practice)
            card.setAttribute('data-id', item.id);
            
            let iconSrc = item.icon || '';
            if (!iconSrc) {
                if (item.type === 'folder') {
                    iconSrc = "data:image/svg+xml;charset=utf8,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23007AFF'%3E%3Cpath d='M10 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2h-8l-2-2z'/%3E%3C/svg%3E";
                } else {
                    try {
                        const domain = new URL(item.url).hostname;
                        iconSrc = `https://www.google.com/s2/favicons?domain=${domain}&sz=64`;
                    } catch (e) {
                        iconSrc = "data:image/svg+xml;charset=utf8,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23ccc'%3E%3Ccircle cx='12' cy='12' r='10'/%3E%3C/svg%3E";
                    }
                }
            }

            card.innerHTML = `
                <button class="delete-btn" onclick="event.stopPropagation(); app.deleteItem(${index})">√ó</button>
                <img src="${iconSrc}" class="card-icon" onerror="this.style.display='none'">
                <div class="card-title">${item.name}</div>
            `;
            
            card.onclick = (e) => {
                if (isEditMode) {
                    e.preventDefault(); // Prevent clicks during edit
                } else {
                    if (item.type === 'folder') openFolder(item.id);
                    else window.open(item.url, '_blank');
                }
            };
            grid.appendChild(card);
        });

        // Update Edit Mode UI
        grid.className = isEditMode ? 'grid edit-mode' : 'grid';
        document.getElementById('editBtn').classList.toggle('active', isEditMode);
        
        // Update Sortable State
        if(sortableInstance) {
            sortableInstance.option("disabled", !isEditMode);
        }
    };

    const openFolder = (id) => { currentFolderId = id; render(); };
    const goHome = () => { currentFolderId = null; render(); };
    
    const deleteItem = (index) => {
        if (!confirm('Delete this item?')) return;
        const list = currentFolderId ? data.folders[currentFolderId] : data.root;
        const item = list[index];
        if (item.type === 'folder' && data.folders[item.id]) delete data.folders[item.id];
        list.splice(index, 1);
        save();
    };

    const saveItem = async () => {
        const type = document.getElementById('itemType').value;
        const name = document.getElementById('itemName').value;
        const url = document.getElementById('itemUrl').value;
        const iconInput = document.getElementById('itemIconInput');

        if (!name) return alert('Please enter a name');
        if (type === 'link' && !url) return alert('Please enter a URL');

        let finalIcon = null;
        if (iconInput.files && iconInput.files[0]) {
            const file = iconInput.files[0];
            if (file.size > 2000000) return alert('Icon too large (<2MB)');
            finalIcon = await readFileAsBase64(file);
        } else if (selectedIconData) {
            finalIcon = selectedIconData;
        }

        const newItem = {
            id: Date.now().toString(),
            type,
            name,
            url: type === 'link' ? (url.startsWith('http') ? url : `https://${url}`) : null,
            icon: finalIcon
        };

        if (type === 'folder') data.folders[newItem.id] = [];
        const targetList = currentFolderId ? data.folders[currentFolderId] : data.root;
        targetList.push(newItem);
        save();
        closeModals();
        
        // Reset
        document.getElementById('itemName').value = '';
        document.getElementById('itemUrl').value = '';
        document.getElementById('itemIconInput').value = ''; 
        document.getElementById('iconSearchInput').value = '';
        document.getElementById('iconResults').style.display = 'none';
        selectedIconData = null;
    };

    const handleBgUpload = async (input) => {
        const file = input.files[0];
        if (!file) return;
        if (file.size > 12000000) return alert('Image too large (<12MB)');
        try { data.bg = await readFileAsBase64(file); save(); applyBg(); } 
        catch (e) { alert("Failed to load background"); }
    };

    const applyBg = () => { if (data.bg) document.body.style.backgroundImage = `url('${data.bg}')`; };
    
    const resetAll = () => { if(confirm("Delete all data?")) { localStorage.removeItem('speedDialData'); location.reload(); }};
    
    const toggleEditMode = () => { 
        isEditMode = !isEditMode; 
        render(); 
    };
    
    const openAddModal = () => document.getElementById('addModal').classList.add('active');
    const openSettings = () => document.getElementById('settingsModal').classList.add('active');
    const closeModals = () => document.querySelectorAll('.modal').forEach(m => m.classList.remove('active'));
    
    const toggleTypeInputs = () => {
        const type = document.getElementById('itemType').value;
        document.getElementById('urlInputGroup').style.display = type === 'folder' ? 'none' : 'block';
    };

    return { 
        init, saveItem, deleteItem, openFolder, goHome, 
        toggleEditMode, openAddModal, openSettings, closeModals, 
        toggleTypeInputs, handleBgUpload, resetAll,
        saveCity, fetchWeather, exportData, importData, searchIcons
    };
})();

app.init();
</script>
</body>
</html>
