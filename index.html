<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>My Speed Dial</title>
    <style>
        :root {
            --glass-bg: rgba(255, 255, 255, 0.15);
            --glass-border: rgba(255, 255, 255, 0.2);
            --text-color: white;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            margin: 0;
            padding: 20px;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            min-height: 100vh;
            background-color: #222;
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            color: var(--text-color);
            transition: background-image 0.3s ease;
        }

        /* --- Search Bar --- */
        .search-container {
            max-width: 600px;
            margin: 40px auto 20px; /* Reduced bottom margin for weather */
            position: relative;
        }

        .search-bar {
            width: 100%;
            padding: 15px 25px;
            border-radius: 30px;
            border: 1px solid var(--glass-border);
            background: rgba(0, 0, 0, 0.4);
            color: white;
            font-size: 1.1rem;
            backdrop-filter: blur(10px);
            outline: none;
            box-shadow: var(--shadow);
            text-align: center;
        }

        /* --- Weather Widget --- */
        .weather-widget {
            max-width: 300px;
            margin: 0 auto 40px;
            text-align: center;
            padding: 8px 16px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 20px;
            backdrop-filter: blur(5px);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            font-size: 0.95rem;
            color: rgba(255, 255, 255, 0.9);
            border: 1px solid rgba(255,255,255,0.1);
            cursor: pointer;
            transition: transform 0.2s, background 0.2s;
        }
        
        .weather-widget:hover {
            background: rgba(0, 0, 0, 0.5);
            transform: scale(1.02);
        }

        /* --- Grid Layout --- */
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(110px, 1fr));
            gap: 20px;
            max-width: 1000px;
            margin: 0 auto;
            padding-bottom: 80px;
        }

        /* --- Cards (Links & Folders) --- */
        .card {
            background: var(--glass-bg);
            backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border);
            border-radius: 16px;
            aspect-ratio: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: transform 0.2s, background 0.2s;
            text-decoration: none;
            color: white;
            position: relative;
            padding: 10px;
            text-align: center;
        }

        .card:hover {
            transform: translateY(-5px);
            background: rgba(255, 255, 255, 0.25);
        }

        .card-icon {
            width: 48px;
            height: 48px;
            border-radius: 8px;
            margin-bottom: 10px;
            object-fit: contain;
        }

        .card-title {
            font-size: 0.9rem;
            font-weight: 500;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            width: 100%;
            text-shadow: 0 1px 3px rgba(0,0,0,0.8);
        }

        .delete-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(255, 0, 0, 0.7);
            border: none;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 12px;
            display: none;
            cursor: pointer;
            z-index: 10;
        }

        .edit-mode .delete-btn { display: block; }
        .edit-mode .card { animation: shake 0.3s infinite alternate; }

        @keyframes shake { from { transform: rotate(-1deg); } to { transform: rotate(1deg); } }

        /* --- Floating Action Buttons --- */
        .fab-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            display: flex;
            gap: 10px;
            z-index: 100;
        }

        .fab {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: none;
            background: #007AFF;
            color: white;
            font-size: 24px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .fab.settings { background: #333; }
        .fab.edit { background: #ff9500; }

        /* --- Modals --- */
        .modal {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.8);
            z-index: 200;
            align-items: center;
            justify-content: center;
        }

        .modal.active { display: flex; }

        .modal-content {
            background: #222;
            padding: 25px;
            border-radius: 16px;
            width: 90%;
            max-width: 400px;
            color: white;
        }

        .modal-content h2 { margin-top: 0; }

        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-size: 0.9rem; color: #aaa; }
        .form-group input, .form-group select {
            width: 100%;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid #444;
            background: #333;
            color: white;
            font-size: 1rem;
        }

        .btn-group { display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px; }
        .btn {
            padding: 10px 20px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-weight: bold;
        }
        .btn-primary { background: #007AFF; color: white; }
        .btn-secondary { background: #444; color: white; }

        /* --- Breadcrumbs --- */
        .breadcrumbs {
            max-width: 1000px;
            margin: 0 auto 20px;
            padding: 0 10px;
            font-size: 1.2rem;
            cursor: pointer;
            text-shadow: 0 1px 3px rgba(0,0,0,0.8);
        }
        .breadcrumb-item:hover { text-decoration: underline; }

    </style>
</head>
<body>

    <div class="search-container">
        <form action="https://www.google.com/search" method="GET">
            <input type="text" name="q" class="search-bar" placeholder="Search Google..." autocomplete="off">
        </form>
    </div>

    <div id="weather" class="weather-widget" onclick="app.fetchWeather(true)">
        <span>Loading Weather...</span>
    </div>

    <div class="breadcrumbs" id="breadcrumbs" style="display: none;">
        <span class="breadcrumb-item" onclick="app.goHome()">üè† Home</span> <span id="folder-name"></span>
    </div>

    <div class="grid" id="grid">
        </div>

    <div class="fab-container">
        <button class="fab edit" onclick="app.toggleEditMode()" title="Edit/Delete">‚úé</button>
        <button class="fab settings" onclick="app.openSettings()" title="Settings">‚öôÔ∏è</button>
        <button class="fab" onclick="app.openAddModal()" title="Add New">+</button>
    </div>

    <div class="modal" id="addModal">
        <div class="modal-content">
            <h2 id="modalTitle">Add Item</h2>
            <div class="form-group">
                <label>Type</label>
                <select id="itemType" onchange="app.toggleTypeInputs()">
                    <option value="link">Link</option>
                    <option value="folder">Folder</option>
                </select>
            </div>
            <div class="form-group">
                <label>Name</label>
                <input type="text" id="itemName" placeholder="e.g., YouTube">
            </div>
            <div class="form-group" id="urlInputGroup">
                <label>URL</label>
                <input type="url" id="itemUrl" placeholder="https://youtube.com">
            </div>
            <div class="btn-group">
                <button class="btn btn-secondary" onclick="app.closeModals()">Cancel</button>
                <button class="btn btn-primary" onclick="app.saveItem()">Save</button>
            </div>
        </div>
    </div>

    <div class="modal" id="settingsModal">
        <div class="modal-content">
            <h2>Settings</h2>
            
            <div class="form-group">
                <label>Background Image</label>
                <input type="file" id="bgInput" accept="image/*" onchange="app.handleBgUpload(this)">
                <p style="font-size: 0.8rem; color: #888; margin-top: 5px;">Images are saved to your browser storage.</p>
            </div>

            <div class="form-group">
                <label>Weather Location (City)</label>
                <input type="text" id="cityInput" placeholder="Leave empty to use GPS">
                <button class="btn btn-primary" style="width: 100%; margin-top: 10px;" onclick="app.saveCity()">Update Weather</button>
            </div>

            <hr style="border: 0; border-top: 1px solid #444; margin: 20px 0;">

            <div class="form-group">
                <label>Danger Zone</label>
                <button class="btn btn-secondary" style="background: #a33; width: 100%" onclick="app.resetAll()">Reset All Data</button>
            </div>
            
            <div class="btn-group">
                <button class="btn btn-secondary" onclick="app.closeModals()">Close</button>
            </div>
        </div>
    </div>

<script>
const app = (() => {
    // --- State ---
    let data = JSON.parse(localStorage.getItem('speedDialData')) || {
        root: [],
        folders: {},
        bg: null,
        city: '' // New: Stores city name
    };
    
    let currentFolderId = null; 
    let isEditMode = false;

    // --- Core Functions ---
    const init = () => {
        applyBg();
        render();
        fetchWeather();
        document.getElementById('cityInput').value = data.city || '';
    };

    const save = () => {
        localStorage.setItem('speedDialData', JSON.stringify(data));
        render();
    };

    // --- Weather Logic (Open-Meteo) ---
    const fetchWeather = async (forceRefresh = false) => {
        const el = document.getElementById('weather');
        
        try {
            let lat, lon, locationName;

            // 1. Check if user typed a city
            if (data.city) {
                const geoReq = await fetch(`https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(data.city)}&count=1&language=en&format=json`);
                const geoRes = await geoReq.json();
                
                if (!geoRes.results || geoRes.results.length === 0) {
                    el.innerHTML = "üö´ City not found";
                    return;
                }
                lat = geoRes.results[0].latitude;
                lon = geoRes.results[0].longitude;
                locationName = geoRes.results[0].name;
            } else {
                // 2. Use Browser GPS
                if (!navigator.geolocation) {
                    el.innerHTML = "üìç Location unavailable";
                    return;
                }
                
                // Wrap geolocation in a promise
                const pos = await new Promise((resolve, reject) => {
                    navigator.geolocation.getCurrentPosition(resolve, reject);
                });
                
                lat = pos.coords.latitude;
                lon = pos.coords.longitude;
                locationName = "My Location";
            }

            // 3. Fetch Forecast (Fahrenheit)
            const weatherReq = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true&temperature_unit=fahrenheit&weathercode=true`);
            const weatherRes = await weatherReq.json();
            
            const temp = Math.round(weatherRes.current_weather.temperature);
            const code = weatherRes.current_weather.weathercode;
            const icon = getWeatherIcon(code);

            el.innerHTML = `${icon} ${temp}¬∞F ‚Ä¢ ${locationName}`;

        } catch (err) {
            console.error(err);
            if (data.city) {
                el.innerHTML = "‚ö†Ô∏è Weather Error";
            } else {
                el.innerHTML = "üìç Enable GPS or set City";
            }
        }
    };

    const getWeatherIcon = (code) => {
        // WMO Weather interpretation codes
        if (code === 0) return '‚òÄÔ∏è';
        if (code >= 1 && code <= 3) return '‚òÅÔ∏è';
        if (code >= 45 && code <= 48) return 'üå´Ô∏è';
        if (code >= 51 && code <= 67) return 'üåßÔ∏è';
        if (code >= 71 && code <= 77) return '‚ùÑÔ∏è';
        if (code >= 80 && code <= 82) return 'üåßÔ∏è';
        if (code >= 95) return '‚õàÔ∏è';
        return 'üå°Ô∏è';
    };

    const saveCity = () => {
        const input = document.getElementById('cityInput');
        data.city = input.value.trim();
        save();
        fetchWeather(true);
        closeModals();
    };

    // --- Rendering ---
    const render = () => {
        const grid = document.getElementById('grid');
        grid.innerHTML = '';
        
        const items = currentFolderId ? (data.folders[currentFolderId] || []) : data.root;

        const breadcrumbs = document.getElementById('breadcrumbs');
        const folderName = document.getElementById('folder-name');
        if (currentFolderId) {
            breadcrumbs.style.display = 'block';
            const parentList = data.root; 
            const folderObj = parentList.find(i => i.id === currentFolderId);
            folderName.innerText = folderObj ? ` > üìÅ ${folderObj.name}` : ' > Folder';
        } else {
            breadcrumbs.style.display = 'none';
        }

        items.forEach((item, index) => {
            const card = document.createElement('div');
            card.className = 'card';
            
            let iconSrc = '';
            if (item.type === 'folder') {
                iconSrc = "data:image/svg+xml;charset=utf8,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23007AFF'%3E%3Cpath d='M10 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2h-8l-2-2z'/%3E%3C/svg%3E";
            } else {
                try {
                    const domain = new URL(item.url).hostname;
                    iconSrc = `https://www.google.com/s2/favicons?domain=${domain}&sz=64`;
                } catch (e) {
                    iconSrc = "data:image/svg+xml;charset=utf8,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23ccc'%3E%3Ccircle cx='12' cy='12' r='10'/%3E%3C/svg%3E";
                }
            }

            card.innerHTML = `
                <button class="delete-btn" onclick="event.stopPropagation(); app.deleteItem(${index})">√ó</button>
                <img src="${iconSrc}" class="card-icon" onerror="this.style.display='none'">
                <div class="card-title">${item.name}</div>
            `;

            card.onclick = () => {
                if (isEditMode) return;
                if (item.type === 'folder') {
                    openFolder(item.id);
                } else {
                    window.location.href = item.url;
                }
            };

            grid.appendChild(card);
        });

        grid.className = isEditMode ? 'grid edit-mode' : 'grid';
    };

    // --- Actions ---
    const openFolder = (id) => { currentFolderId = id; render(); };
    const goHome = () => { currentFolderId = null; render(); };

    const deleteItem = (index) => {
        if (!confirm('Delete this item?')) return;
        const list = currentFolderId ? data.folders[currentFolderId] : data.root;
        const item = list[index];
        if (item.type === 'folder' && data.folders[item.id]) delete data.folders[item.id];
        list.splice(index, 1);
        save();
    };

    const saveItem = () => {
        const type = document.getElementById('itemType').value;
        const name = document.getElementById('itemName').value;
        const url = document.getElementById('itemUrl').value;

        if (!name) return alert('Please enter a name');
        if (type === 'link' && !url) return alert('Please enter a URL');

        const newItem = {
            id: Date.now().toString(),
            type,
            name,
            url: type === 'link' ? (url.startsWith('http') ? url : `https://${url}`) : null
        };

        if (type === 'folder') data.folders[newItem.id] = [];
        const targetList = currentFolderId ? data.folders[currentFolderId] : data.root;
        targetList.push(newItem);
        save();
        closeModals();
        
        document.getElementById('itemName').value = '';
        document.getElementById('itemUrl').value = '';
    };

    const handleBgUpload = (input) => {
        const file = input.files[0];
        if (!file) return;
        if (file.size > 12000000) return alert('Image too large (<12MB only)');
        const reader = new FileReader();
        reader.onloadend = () => {
            data.bg = reader.result;
            save();
            applyBg();
        };
        reader.readAsDataURL(file);
    };

    const applyBg = () => {
        if (data.bg) document.body.style.backgroundImage = `url('${data.bg}')`;
    };

    const resetAll = () => {
        if(confirm("Delete all data?")){
            localStorage.removeItem('speedDialData');
            location.reload();
        }
    };

    const toggleEditMode = () => { isEditMode = !isEditMode; render(); };
    const openAddModal = () => document.getElementById('addModal').classList.add('active');
    const openSettings = () => document.getElementById('settingsModal').classList.add('active');
    const closeModals = () => document.querySelectorAll('.modal').forEach(m => m.classList.remove('active'));
    
    const toggleTypeInputs = () => {
        const type = document.getElementById('itemType').value;
        document.getElementById('urlInputGroup').style.display = type === 'folder' ? 'none' : 'block';
    };

    return { 
        init, saveItem, deleteItem, openFolder, goHome, 
        toggleEditMode, openAddModal, openSettings, closeModals, 
        toggleTypeInputs, handleBgUpload, resetAll,
        saveCity, fetchWeather
    };
})();

app.init();
</script>
</body>
</html>
